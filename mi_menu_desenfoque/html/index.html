<!DOCTYPE html>
<html>
<head>
    <title>Menú FiveM Blur Mejorado</title>
    
    <link rel="stylesheet" href="style.css">
</head>
<body>
    
    <div id="notification-container" style="
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        pointer-events: none;
        display: flex;
        flex-direction: column;
        gap: 10px;
    ">
        </div>

    <div class="menu-container" id="menu-principal">
        <h1>Menú Principal</h1>
        <p style="margin-bottom: 20px;">El juego debe verse borroso detrás de mí.</p>
        
        <button onclick="sendActionToLua('ejecutar_accion_uno')" 
            style="background-color: #007bff; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; margin-top: 5px;">
            Hacer Algo (Ejecuta en Lua)
        </button>
        
        <button onclick="showMenu('opciones')"
            style="background-color: #17a2b8; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; margin-top: 10px;">
            Ir a Opciones
        </button>

        <button onclick="showMenu('jugadores')"
            style="background-color: #3f88c5; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; margin-top: 10px;">
            Ver Lista de Jugadores
        </button>
    </div>

    <div class="menu-container" id="submenu-opciones" style="display: none;">
        <h1>Submenú: Opciones</h1>
        
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
            <span>Modo Siempre Día</span>
            <button id="toggle-dia" onclick="toggleOption('siempre_dia')"
                style="background-color: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">
                OFF
            </button>
        </div>

        <div style="margin-top: 20px; padding-top: 10px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
            <label for="input-mensaje" style="color: #ccc; margin-bottom: 5px; display: block;">Enviar Mensaje al Chat:</label>
            <input type="text" id="input-mensaje" placeholder="Escribe tu mensaje aquí..."
                style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #555; background-color: rgba(0, 0, 0, 0.3); color: white; box-sizing: border-box;">
            
            <button onclick="sendChatMessage()"
                style="width: 100%; background-color: #ffc107; color: black; border: none; padding: 10px; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                Enviar Mensaje
            </button>
        </div>
        
        <div style="margin-top: 20px; padding-top: 10px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
            <label for="slider-velocidad" style="color: #ccc; margin-bottom: 5px; display: block;">Velocidad del Jugador: <span id="slider-valor">5.0</span></label>
            
            <input type="range" id="slider-velocidad" min="1.0" max="10.0" step="0.5" value="5.0"
                oninput="updateSliderValue(this.value)"
                onmouseup="sendSliderValue(this.value)"
                style="width: 100%; height: 25px; cursor: pointer;">
        </div>
        
        <button onclick="showMenu('main')" 
            style="background-color: #dc3545; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; margin-top: auto;">
            ← Volver al Menú Principal
        </button>
    </div>

    <div class="menu-container" id="submenu-jugadores" style="display: none;">
        <h1>Lista de Jugadores (Prueba)</h1>
        
        <div id="player-list-container" style="flex-grow: 1; overflow-y: auto; padding: 5px; border: 1px solid rgba(255, 255, 255, 0.2);">
            <p style="text-align: center; color: #aaa;">Cargando jugadores...</p>
        </div>
        
        <button onclick="requestPlayerList()" 
            style="background-color: #3f88c5; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; margin-top: 10px;">
            Actualizar Lista
        </button>
        
        <button onclick="showMenu('main')" 
            style="background-color: #dc3545; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; margin-top: 10px;">
            ← Volver al Menú Principal
        </button>
    </div>


    <script src="app.js"></script> 

    <script>
        // Declaramos GetParentResourceName si no existe para que el fetch funcione
        const GetParentResourceName = () => { return 'mi_menú_desenfoque'; };
        
        // CÓDIGO COMPLETO Y CORREGIDO DE ARRASTRE Y PERSISTENCIA (SIN DUPLICADOS)
        const menu = document.getElementById('menu-principal');
        const STORAGE_KEY = 'menuPosition';
        let isDragging = false;
        let offsetX, offsetY;
        
        // FUNCIÓN ACTUALIZADA: CARGAR POSICIÓN CON LÍMITES (Robustez)
        function loadPosition() {
            const savedPos = localStorage.getItem(STORAGE_KEY);
            if (savedPos && menu) {
                const { left, top } = JSON.parse(savedPos);
                
                // --- CÓDIGO: VALIDACIÓN DE LÍMITES ---
                const menuWidth = menu.offsetWidth;
                const menuHeight = menu.offsetHeight;
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;

                let finalLeft = parseFloat(left);
                let finalTop = parseFloat(top);
                
                // 1. Asegurar que no esté fuera del borde derecho
                if (finalLeft + menuWidth > screenWidth) {
                    finalLeft = screenWidth - menuWidth - 20; 
                }
                // 2. Asegurar que no esté fuera del borde inferior
                if (finalTop + menuHeight > screenHeight) {
                    finalTop = screenHeight - menuHeight - 20; 
                }
                // 3. Asegurar que no esté fuera del borde izquierdo/superior (mínimo 20px)
                if (finalLeft < 20) { finalLeft = 20; }
                if (finalTop < 20) { finalTop = 20; }
                
                menu.style.left = finalLeft + 'px';
                menu.style.top = finalTop + 'px';
                // --- FIN DEL CÓDIGO DE LÍMITES ---
                
                menu.style.transform = 'none'; // Desactiva el centrado CSS
            }
        }

        if (menu) {
            loadPosition();

            menu.addEventListener('mousedown', (e) => {
                if (e.target.tagName === 'H1') {
                    isDragging = true;
                    offsetX = e.clientX - menu.getBoundingClientRect().left;
                    offsetY = e.clientY - menu.getBoundingClientRect().top;
                    menu.style.cursor = 'grabbing';
                }
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                menu.style.left = e.clientX - offsetX + 'px';
                menu.style.top = e.clientY - offsetY + 'px';
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    // FUNCIÓN AÑADIDA: GUARDAR POSICIÓN
                    const currentPos = {
                        left: menu.style.left,
                        top: menu.style.top
                    };
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(currentPos));
                }
                isDragging = false;
                if (menu) {
                    menu.style.cursor = 'default';
                }
            });
        }
        
        // =================================================================
        // FUNCIÓN DE COMUNICACIÓN (sendActionToLua)
        // =================================================================
        function sendActionToLua(actionName, data = {}) {
            fetch(`https://${GetParentResourceName()}/${actionName}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json; charset=UTF-8',
                },
                body: JSON.stringify(data)
            });
        }
        
        // =================================================================
        // FUNCIÓN DE CONTROL DE VISTAS (showMenu) Y ANIMACIÓN
        // =================================================================
        const menuPrincipal = document.getElementById('menu-principal');
        const menuOpciones = document.getElementById('submenu-opciones');
        const menuJugadores = document.getElementById('submenu-jugadores');

        function showMenu(menuName) {
            const allMenus = [menuPrincipal, menuOpciones, menuJugadores];
            
            allMenus.forEach(m => { 
                if(m) {
                    // Cierre animado si ya estaba abierto
                    if (m.style.display !== 'none') {
                        m.classList.remove('menu-enter');
                        m.classList.add('menu-exit');
                        // Ocultar después de la animación de cierre
                        setTimeout(() => m.style.display = 'none', 300);
                    } else {
                        m.style.display = 'none';
                    }
                }
            });
            
            let targetMenu;
            if (menuName === 'main') {
                targetMenu = menuPrincipal;
            } else if (menuName === 'opciones') {
                targetMenu = menuOpciones;
            } else if (menuName === 'jugadores') {
                targetMenu = menuJugadores;
                requestPlayerList(); // Pedir lista inmediatamente al abrir
            }

            if (targetMenu) {
                targetMenu.style.display = 'flex';
                // Aplicar la animación de entrada
                targetMenu.classList.remove('menu-exit');
                targetMenu.classList.add('menu-enter');
                
                // Asegurar que el submenú se centre
                if (menuName !== 'main') {
                    targetMenu.style.transform = 'translate(-50%, -50%)';
                }
            }
        }
        
        // =================================================================
        // LÓGICA DE COMPONENTES: TOGGLE, INPUT, SLIDER
        // =================================================================
        let isDiaOn = false;

        function toggleOption(optionName) {
            if (optionName === 'siempre_dia') {
                isDiaOn = !isDiaOn;
                const button = document.getElementById('toggle-dia');
                
                button.textContent = isDiaOn ? 'ON' : 'OFF';
                button.style.backgroundColor = isDiaOn ? '#28a745' : '#dc3545';

                sendActionToLua('toggle_' + optionName, { estado: isDiaOn });
                showNotification(`Modo Siempre Día ${isDiaOn ? 'ACTIVADO' : 'DESACTIVADO'}.`, 'success', 2000);
            }
        }

        function sendChatMessage() {
            const inputField = document.getElementById('input-mensaje');
            const messageText = inputField.value;

            if (messageText.trim() === '') {
                showNotification('El mensaje no puede estar vacío.', 'error', 2000);
                return;
            }

            sendActionToLua('enviar_mensaje_chat', { mensaje: messageText });
            inputField.value = '';
            showNotification('Mensaje enviado al chat.', 'success', 2000);
        }
        
        function updateSliderValue(value) {
            document.getElementById('slider-valor').textContent = parseFloat(value).toFixed(1);
        }

        function sendSliderValue(value) {
            const finalValue = parseFloat(value);
            sendActionToLua('ajustar_velocidad', { velocidad: finalValue });
            showNotification(`Velocidad ajustada a ${finalValue.toFixed(1)}.`, 'success', 2000);
        }
        
        // =================================================================
        // LÓGICA DE LISTAS DINÁMICAS (Jugadores)
        // =================================================================

        /**
         * Le pide a Lua que envíe la tabla de jugadores.
         */
        function requestPlayerList() {
            sendActionToLua('request_player_data', {});
            document.getElementById('player-list-container').innerHTML = 
                '<p style="text-align: center; color: #aaa;">Cargando...</p>';
        }

        /**
         * Dibuja la lista de jugadores recibida desde Lua.
         * @param {array} playerData - Un array de objetos {id: number, name: string}.
         */
        window.renderPlayerList = function(playerData) {
            const container = document.getElementById('player-list-container');
            container.innerHTML = ''; // Limpiar el contenido anterior

            if (!playerData || playerData.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #aaa;">No hay jugadores en el rango.</p>';
                return;
            }

            playerData.forEach(player => {
                const playerItem = document.createElement('div');
                playerItem.innerHTML = `[ID: ${player.id}] ${player.name} (Ping: ${player.ping || 'N/A'})`;
                playerItem.style.cssText = `
                    padding: 8px; 
                    margin-bottom: 5px; 
                    background: rgba(255, 255, 255, 0.1); 
                    border-radius: 5px; 
                    cursor: pointer;
                    transition: background 0.2s;
                `;
                // Puedes añadir una acción aquí, ej: playerItem.onclick = () => sendActionToLua('teleport_to', { id: player.id });
                
                playerItem.addEventListener('mouseover', () => playerItem.style.background = 'rgba(255, 255, 255, 0.2)');
                playerItem.addEventListener('mouseout', () => playerItem.style.background = 'rgba(255, 255, 255, 0.1)');

                container.appendChild(playerItem);
            });
        }
        
        // =================================================================
        // SISTEMA DE NOTIFICACIONES (showNotification)
        // =================================================================
        window.showNotification = function(message, type, duration = 3000) {
            const container = document.getElementById('notification-container');
            const bgColor = type === 'success' ? 'rgba(40, 167, 69, 0.9)' : 'rgba(220, 53, 69, 0.9)';
            const titleText = type === 'success' ? 'Éxito' : 'Error';

            const notification = document.createElement('div');
            notification.innerHTML = `<strong>${titleText}:</strong> ${message}`;
            
            notification.style.cssText = `
                padding: 12px 18px;
                border-radius: 8px;
                color: white;
                font-family: sans-serif;
                font-size: 14px;
                max-width: 300px;
                background: ${bgColor};
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                border: 1px solid rgba(255, 255, 255, 0.2);
                opacity: 0;
                transform: translateX(100%);
                transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            `;
            
            container.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 50);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                
                setTimeout(() => {
                    notification.remove();
                }, 500); 
            }, duration);
        }

        // =================================================================
        // GESTIÓN DE ANIMACIONES Y EVENTOS (Listener principal)
        // =================================================================
        window.addEventListener('message', function(event) {
            const data = event.data;
            
            if (data.action === 'openMenu') {
                showMenu('main'); // Abre el menú principal con animación
            } else if (data.action === 'closeMenu') {
                // Aplica la animación de salida a CUALQUIER menú que esté visible
                const visibleMenu = document.querySelector('.menu-container[style*="display: flex"]');
                if (visibleMenu) {
                    visibleMenu.classList.remove('menu-enter');
                    visibleMenu.classList.add('menu-exit');

                    setTimeout(() => {
                        visibleMenu.style.display = 'none';
                    }, 300);
                }
            } else if (data.action === 'showNotification') {
                // Recibe la notificación desde Lua
                showNotification(data.message, data.type);
            } else if (data.action === 'renderPlayerList') {
                // Recibe los datos de los jugadores desde Lua y los dibuja
                if (data.data && window.renderPlayerList) {
                    window.renderPlayerList(data.data);
                }
            }
        });
    </script> 
</body>
</html>
